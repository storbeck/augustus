package exploitation

import (
	"context"
	"fmt"

	"github.com/praetorian-inc/augustus/pkg/attempt"
	"github.com/praetorian-inc/augustus/pkg/probes"
	"github.com/praetorian-inc/augustus/pkg/registry"
)

func init() {
	probes.Register("exploitation.SQLInjectionSystem", NewSQLInjectionSystem)
}

// SQLInjectionSystem attempts to inject untrusted SQL commands.
// Tests if LLM will execute or relay SQL injection payloads.
//
// NOTE: Detecting success requires inspection of target SQL database.
// This probe is for security testing only.
//
// CWE References: CWE-89, CWE-1426, CWE-1427
type SQLInjectionSystem struct {
	prompts []string
}

// NewSQLInjectionSystem creates a new SQLInjectionSystem probe.
func NewSQLInjectionSystem(cfg registry.Config) (probes.Prober, error) {
	probe := &SQLInjectionSystem{}
	probe.init()
	return probe, nil
}

// init generates SQL injection prompts.
func (p *SQLInjectionSystem) init() {
	p.prompts = make([]string, 0, len(SQLInjectionPayloads)+len(SQLTopInstructions))

	// Add SQL payloads with exact execution template
	for _, payload := range SQLInjectionPayloads {
		prompt := fmt.Sprintf(SQL_EXACT_TEMPLATE, payload)
		p.prompts = append(p.prompts, prompt)
	}

	// Add natural language SQL instructions
	for _, instruction := range SQLTopInstructions {
		prompt := fmt.Sprintf(SQL_COMMAND_TEMPLATE, instruction)
		p.prompts = append(p.prompts, prompt)
	}
}

// Probe executes the probe against the generator.
func (p *SQLInjectionSystem) Probe(ctx context.Context, gen probes.Generator) ([]*attempt.Attempt, error) {
	return executeProbe(ctx, gen, p)
}

// Name returns the probe's fully qualified name.
func (p *SQLInjectionSystem) Name() string {
	return "exploitation.SQLInjectionSystem"
}

// Description returns a human-readable description.
func (p *SQLInjectionSystem) Description() string {
	return "Attempts to inject untrusted SQL commands into a SQL statement. " +
		"Tests if LLM will execute or relay SQL injection payloads."
}

// Goal returns the probe's objective.
func (p *SQLInjectionSystem) Goal() string {
	return "Manipulate a database via SQL injection"
}

// GetPrimaryDetector returns the recommended detector.
func (p *SQLInjectionSystem) GetPrimaryDetector() string {
	return "exploitation.SQLiSuccess"
}

// GetPrompts returns the attack prompts used by this probe.
func (p *SQLInjectionSystem) GetPrompts() []string {
	return p.prompts
}

package exploitation

import (
	"context"

	"github.com/praetorian-inc/augustus/pkg/attempt"
	"github.com/praetorian-inc/augustus/pkg/probes"
)

// probeInterface defines the minimal interface needed by executeProbe.
type probeInterface interface {
	Name() string
	GetPrimaryDetector() string
	GetPrompts() []string
}

// executeProbe is a shared helper that eliminates duplicate Probe() implementations.
// All exploitation probes use this to avoid DRY violations.
//
// This pattern could be extracted to a higher level (pkg/probes) to benefit all probes,
// but is currently scoped to exploitation package to avoid cross-cutting changes.
func executeProbe(ctx context.Context, gen probes.Generator, probe probeInterface) ([]*attempt.Attempt, error) {
	prompts := probe.GetPrompts()
	attempts := make([]*attempt.Attempt, 0, len(prompts))

	for _, prompt := range prompts {
		conv := attempt.NewConversation()
		conv.AddPrompt(prompt)

		responses, err := gen.Generate(ctx, conv, 1)

		a := attempt.New(prompt)
		a.Probe = probe.Name()
		a.Detector = probe.GetPrimaryDetector()

		if err != nil {
			a.SetError(err)
		} else {
			for _, resp := range responses {
				a.AddOutput(resp.Content)
			}
			a.Complete()
		}

		attempts = append(attempts, a)
	}

	return attempts, nil
}

package exploitation

import (
	"context"
	"fmt"

	"github.com/praetorian-inc/augustus/pkg/attempt"
	"github.com/praetorian-inc/augustus/pkg/probes"
	"github.com/praetorian-inc/augustus/pkg/registry"
)

func init() {
	probes.Register("exploitation.JinjaTemplatePythonInjection", NewJinjaTemplatePythonInjection)
}

// JinjaTemplatePythonInjection attempts to execute Python code via Jinja templating.
// Uses echo prompts to get models to output Jinja template syntax that could
// lead to code execution if rendered by a template engine.
//
// Attack Vector:
//   1. Model is prompted to echo content
//   2. Content contains Jinja template syntax: {{ payload }}
//   3. If output is passed to Jinja renderer, Python code executes
//
// CWE References: CWE-94, CWE-95, CWE-1336
type JinjaTemplatePythonInjection struct {
	prompts []string
}

// NewJinjaTemplatePythonInjection creates a new JinjaTemplatePythonInjection probe.
func NewJinjaTemplatePythonInjection(cfg registry.Config) (probes.Prober, error) {
	probe := &JinjaTemplatePythonInjection{}
	probe.init()
	return probe, nil
}

// init generates prompts by wrapping payloads in Jinja template syntax.
func (p *JinjaTemplatePythonInjection) init() {
	p.prompts = make([]string, 0, len(PythonCodeExecutionPayloads))

	for _, payload := range PythonCodeExecutionPayloads {
		// Wrap payload in Jinja template syntax: {{ payload }}
		jinjaPayload := fmt.Sprintf("{{%s}}", payload)
		prompt := fmt.Sprintf(ECHO_TEMPLATE, jinjaPayload)
		p.prompts = append(p.prompts, prompt)
	}
}

// Probe executes the probe against the generator.
func (p *JinjaTemplatePythonInjection) Probe(ctx context.Context, gen probes.Generator) ([]*attempt.Attempt, error) {
	return executeProbe(ctx, gen, p)
}

// Name returns the probe's fully qualified name.
func (p *JinjaTemplatePythonInjection) Name() string {
	return "exploitation.JinjaTemplatePythonInjection"
}

// Description returns a human-readable description.
func (p *JinjaTemplatePythonInjection) Description() string {
	return "Attempts to execute Python code via Jinja template injection. " +
		"Tests if models will echo malicious Jinja templates that could execute code."
}

// Goal returns the probe's objective.
func (p *JinjaTemplatePythonInjection) Goal() string {
	return "Gain remote code execution via Jinja template injection"
}

// GetPrimaryDetector returns the recommended detector.
func (p *JinjaTemplatePythonInjection) GetPrimaryDetector() string {
	return "exploitation.JinjaTemplateDetector"
}

// GetPrompts returns the attack prompts used by this probe.
func (p *JinjaTemplatePythonInjection) GetPrompts() []string {
	return p.prompts
}

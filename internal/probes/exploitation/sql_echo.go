package exploitation

import (
	"context"
	"fmt"

	"github.com/praetorian-inc/augustus/pkg/attempt"
	"github.com/praetorian-inc/augustus/pkg/probes"
	"github.com/praetorian-inc/augustus/pkg/registry"
)

func init() {
	probes.Register("exploitation.SQLInjectionEcho", NewSQLInjectionEcho)
}

// SQLInjectionEcho attempts to get the target to echo SQL injection payloads.
// In some applications, echoed SQL may be executed, creating a vulnerability.
//
// Attack Vector:
//   1. Model is prompted to echo content
//   2. Content contains SQL injection payload
//   3. If output is used in SQL query construction, injection occurs
//
// CWE References: CWE-89, CWE-1426, CWE-1427
type SQLInjectionEcho struct {
	prompts []string
}

// NewSQLInjectionEcho creates a new SQLInjectionEcho probe.
func NewSQLInjectionEcho(cfg registry.Config) (probes.Prober, error) {
	probe := &SQLInjectionEcho{}
	probe.init()
	return probe, nil
}

// init generates prompts by combining echo template with SQL payloads.
func (p *SQLInjectionEcho) init() {
	p.prompts = make([]string, 0, len(SQLInjectionPayloads))

	for _, payload := range SQLInjectionPayloads {
		prompt := fmt.Sprintf(ECHO_TEMPLATE, payload)
		p.prompts = append(p.prompts, prompt)
	}
}

// Probe executes the probe against the generator.
func (p *SQLInjectionEcho) Probe(ctx context.Context, gen probes.Generator) ([]*attempt.Attempt, error) {
	return executeProbe(ctx, gen, p)
}

// Name returns the probe's fully qualified name.
func (p *SQLInjectionEcho) Name() string {
	return "exploitation.SQLInjectionEcho"
}

// Description returns a human-readable description.
func (p *SQLInjectionEcho) Description() string {
	return "Attempts to get the target to echo a SQL statement. " +
		"Echoed SQL may be insecure if used in query construction."
}

// Goal returns the probe's objective.
func (p *SQLInjectionEcho) Goal() string {
	return "Manipulate a database via SQL injection"
}

// GetPrimaryDetector returns the recommended detector.
func (p *SQLInjectionEcho) GetPrimaryDetector() string {
	return "exploitation.SQLiEcho"
}

// GetPrompts returns the attack prompts used by this probe.
func (p *SQLInjectionEcho) GetPrompts() []string {
	return p.prompts
}

package malwaregen

import (
	"context"
	"testing"

	"github.com/praetorian-inc/augustus/pkg/attempt"
	"github.com/praetorian-inc/augustus/pkg/detectors"
	"github.com/praetorian-inc/augustus/pkg/registry"
	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"
)

func TestAnyCode_DetectsPython(t *testing.T) {
	detector, err := NewAnyCode(registry.Config{})
	require.NoError(t, err)

	a := &attempt.Attempt{
		Outputs: []string{
			`def main():
    import sys
    print("Hello, world!")
if __name__ == "__main__":
    main()`,
		},
	}

	scores, err := detector.Detect(context.Background(), a)
	require.NoError(t, err)
	require.Len(t, scores, 1)
	assert.Equal(t, 1.0, scores[0], "should detect Python code")
}

func TestAnyCode_DetectsC(t *testing.T) {
	detector, err := NewAnyCode(registry.Config{})
	require.NoError(t, err)

	a := &attempt.Attempt{
		Outputs: []string{
			`#include<stdio.h>
int main() {
    printf("Hello\\n");
    return 0;
}`,
		},
	}

	scores, err := detector.Detect(context.Background(), a)
	require.NoError(t, err)
	require.Len(t, scores, 1)
	assert.Equal(t, 1.0, scores[0], "should detect C code")
}

func TestAnyCode_DetectsRust(t *testing.T) {
	detector, err := NewAnyCode(registry.Config{})
	require.NoError(t, err)

	a := &attempt.Attempt{
		Outputs: []string{
			`fn main() {
    println!("Hello, world!");
}`,
		},
	}

	scores, err := detector.Detect(context.Background(), a)
	require.NoError(t, err)
	require.Len(t, scores, 1)
	assert.Equal(t, 1.0, scores[0], "should detect Rust code")
}

func TestAnyCode_DetectsAssembly(t *testing.T) {
	detector, err := NewAnyCode(registry.Config{})
	require.NoError(t, err)

	a := &attempt.Attempt{
		Outputs: []string{
			`section .text
global _start
_start:
    mov eax, 1
    int 0x80`,
		},
	}

	scores, err := detector.Detect(context.Background(), a)
	require.NoError(t, err)
	require.Len(t, scores, 1)
	assert.Equal(t, 1.0, scores[0], "should detect Assembly code")
}

func TestAnyCode_DetectsX86(t *testing.T) {
	detector, err := NewAnyCode(registry.Config{})
	require.NoError(t, err)

	a := &attempt.Attempt{
		Outputs: []string{
			`mov rax, rsi
cmp rbx, rcx
jne label`,
		},
	}

	scores, err := detector.Detect(context.Background(), a)
	require.NoError(t, err)
	require.Len(t, scores, 1)
	assert.Equal(t, 1.0, scores[0], "should detect x86_64 code")
}

func TestAnyCode_NonCodeText(t *testing.T) {
	detector, err := NewAnyCode(registry.Config{})
	require.NoError(t, err)

	a := &attempt.Attempt{
		Outputs: []string{
			"This is just plain text without any code.",
		},
	}

	scores, err := detector.Detect(context.Background(), a)
	require.NoError(t, err)
	require.Len(t, scores, 1)
	assert.Equal(t, 0.0, scores[0], "should not detect non-code text")
}

func TestAnyCode_EmptyOutput(t *testing.T) {
	detector, err := NewAnyCode(registry.Config{})
	require.NoError(t, err)

	a := &attempt.Attempt{
		Outputs: []string{""},
	}

	scores, err := detector.Detect(context.Background(), a)
	require.NoError(t, err)
	require.Len(t, scores, 1)
	assert.Equal(t, 0.0, scores[0], "should return 0.0 for empty output")
}

func TestAnyCode_MultipleOutputs(t *testing.T) {
	detector, err := NewAnyCode(registry.Config{})
	require.NoError(t, err)

	a := &attempt.Attempt{
		Outputs: []string{
			"No code here",
			"def test(): pass",
			"Still no code",
			"#include<stdio.h>",
		},
	}

	scores, err := detector.Detect(context.Background(), a)
	require.NoError(t, err)
	require.Len(t, scores, 4)
	assert.Equal(t, 0.0, scores[0], "first output has no code")
	assert.Equal(t, 1.0, scores[1], "second output has Python code")
	assert.Equal(t, 0.0, scores[2], "third output has no code")
	assert.Equal(t, 1.0, scores[3], "fourth output has C code")
}

func TestAnyCode_ImplementsDetectorInterface(t *testing.T) {
	detector, err := NewAnyCode(registry.Config{})
	require.NoError(t, err)

	// Verify it implements the Detector interface
	var _ detectors.Detector = detector

	// Check required methods
	assert.Equal(t, "malwaregen.AnyCode", detector.Name())
	assert.NotEmpty(t, detector.Description())
}

func TestAnyCode_Registration(t *testing.T) {
	// Verify the detector is registered
	factory, ok := detectors.Get("malwaregen.AnyCode")
	assert.True(t, ok, "detector should be registered")
	assert.NotNil(t, factory)

	// Verify we can create it via the registry
	detector, err := detectors.Create("malwaregen.AnyCode", registry.Config{})
	require.NoError(t, err)
	assert.NotNil(t, detector)
}

func TestAnyCode_DetectsCppWithComments(t *testing.T) {
	detector, err := NewAnyCode(registry.Config{})
	require.NoError(t, err)

	a := &attempt.Attempt{
		Outputs: []string{
			`// This is a C++ comment
#include <iostream>
int main() {
    std::cout << "Hello";
    return 0;
}`,
		},
	}

	scores, err := detector.Detect(context.Background(), a)
	require.NoError(t, err)
	require.Len(t, scores, 1)
	assert.Equal(t, 1.0, scores[0], "should detect C++ code")
}

func TestAnyCode_DetectsCSharp(t *testing.T) {
	detector, err := NewAnyCode(registry.Config{})
	require.NoError(t, err)

	a := &attempt.Attempt{
		Outputs: []string{
			`using System;
namespace HelloWorld {
    class Program {
        static void Main() {
            Console.WriteLine("Hello");
        }
    }
}`,
		},
	}

	scores, err := detector.Detect(context.Background(), a)
	require.NoError(t, err)
	require.Len(t, scores, 1)
	assert.Equal(t, 1.0, scores[0], "should detect C# code")
}

func TestAnyCode_CodeInMarkdownFence(t *testing.T) {
	detector, err := NewAnyCode(registry.Config{})
	require.NoError(t, err)

	a := &attempt.Attempt{
		Outputs: []string{
			"```python\ndef hello():\n    print('world')\n```",
		},
	}

	scores, err := detector.Detect(context.Background(), a)
	require.NoError(t, err)
	require.Len(t, scores, 1)
	assert.Equal(t, 1.0, scores[0], "should detect code even in markdown fence")
}
